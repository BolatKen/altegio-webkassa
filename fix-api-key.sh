#!/bin/bash

echo "üîß –†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è API –∫–ª—é—á–∞ Webkassa"
echo "================================================"
echo ""

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–±–æ—Ç—É —Å–µ—Ä–≤–µ—Ä–∞
echo "1Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–µ—Ä–∞..."
if curl -s http://165.227.159.243:8001/health > /dev/null 2>&1; then
    echo "‚úÖ –°–µ—Ä–≤–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç (165.227.159.243:8001)"
else
    echo "‚ùå –°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (165.227.159.243:8001)"
    echo "üîç –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:"
    echo "   - –°–µ—Ä–≤–µ—Ä –Ω–µ –∑–∞–ø—É—â–µ–Ω"
    echo "   - –ü—Ä–æ–±–ª–µ–º—ã —Å —Å–µ—Ç—å—é"
    echo "   - –ü–æ—Ä—Ç 8001 –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω"
    exit 1
fi

echo ""
echo "2Ô∏è‚É£ –ü–æ–ø—ã—Ç–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–ª—É—á–µ–Ω–∏—è API –∫–ª—é—á–∞..."

# –ü—ã—Ç–∞–µ–º—Å—è –æ–±–Ω–æ–≤–∏—Ç—å API –∫–ª—é—á —á–µ—Ä–µ–∑ —ç–Ω–¥–ø–æ–∏–Ω—Ç
echo "üîÑ –ó–∞–ø—Ä–æ—Å –∫ —ç–Ω–¥–ø–æ–∏–Ω—Ç—É..."
response=$(curl -s -X POST http://165.227.159.243:8001/webhook/refresh-api-key)
echo "üìã –ü–æ–ª–Ω—ã–π –æ—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:"
echo "$response" | jq . 2>/dev/null || echo "$response"
echo ""

if echo "$response" | grep -q '"success": *true'; then
    echo "‚úÖ API –∫–ª—é—á —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω —á–µ—Ä–µ–∑ –≤–µ–±-—ç–Ω–¥–ø–æ–∏–Ω—Ç"
else
    echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å API –∫–ª—é—á"
    echo ""
    echo "üîç –ê–Ω–∞–ª–∏–∑ –æ—Ç–≤–µ—Ç–∞:"
    if echo "$response" | grep -q '"error"'; then
        error_msg=$(echo "$response" | grep -o '"error"[^}]*' | sed 's/"error"://g' | tr -d '"')
        echo "   ÔøΩ –û—à–∏–±–∫–∞: $error_msg"
    fi
    echo ""
    echo "ÔøΩüîç –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:"
    echo "   - –ù–µ–≤–µ—Ä–Ω—ã–µ credentials –≤ .env —Ñ–∞–π–ª–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ"
    echo "   - –ü—Ä–æ–±–ª–µ–º—ã —Å —Å–µ—Ç—å—é –¥–æ API Webkassa"
    echo "   - API Webkassa –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
    echo "   - –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Ñ–∞–π–ª —Å–∫—Ä–∏–ø—Ç–∞ update_webkassa_key.py"
    echo ""
    echo "üìã –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ"
    exit 1
fi

echo ""
echo "3Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç..."

# –¢–µ—Å—Ç–∏—Ä—É–µ–º webhook
echo "üß™ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π webhook..."
curl -s -X POST -H "Content-Type: application/json" \
    http://165.227.159.243:8001/webhook/test \
    -d '{"test": "api_key_fix_test", "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"}'

echo ""
echo ""
echo "‚úÖ –ì–æ—Ç–æ–≤–æ! –ü—Ä–æ–±–ª–µ–º–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Ä–µ—à–µ–Ω–∞."
echo ""
echo "üì± –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram –±–æ—Ç–µ"
echo "üìã –õ–æ–≥–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ: docker logs <container_name>"
echo ""
echo "üîó –í–∞—à webhook URL –¥–ª—è Altegio:"
echo "   http://165.227.159.243:8001/webhook"
